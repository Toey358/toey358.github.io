<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Radar System - VTUD</title>
    
    <!-- Leaflet CSS -->
    <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f7fa;
            color: #333;
            overflow-x: hidden;
        }

        /* Lucide Icons */
        .lucide {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        /* Navbar */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(135deg, #2196F3 0%, #42A5F5 50%, #64B5F6 100%);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: 0 2px 15px rgba(33, 150, 243, 0.3);
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .navbar-brand .logo {
            width: 50px;
            height: 50px;
            background: transparent;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .navbar-brand .title h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            letter-spacing: -0.3px;
        }

        .current-time {
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
        }

        /* Main Container */
        .main-container {
            margin-top: 100px;
            padding: 20px;
            max-width: 1800px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Card Style */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .card-header {
            padding: 20px 25px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }

        .card-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .card-header h2 .lucide {
            color: #2196F3;
            width: 24px;
            height: 24px;
        }

        .card-body {
            padding: 25px;
        }

        /* METAR Dashboard with Charts */
        .metar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metar-chart-card {
            background: white;
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .metar-chart-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 16px rgba(33, 150, 243, 0.2);
        }

        .chart-container {
            width: 140px;
            height: 140px;
            position: relative;
            margin-bottom: 15px;
        }

        .chart-label {
            font-size: 0.75rem;
            color: #7f8c8d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .chart-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            text-align: center;
            margin-top: 5px;
        }

        .chart-unit {
            font-size: 0.9rem;
            color: #95a5a6;
            margin-left: 3px;
        }

        /* Info Cards Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .info-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #e9ecef;
        }

        .info-label {
            font-size: 0.75rem;
            color: #7f8c8d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .info-icon {
            margin-bottom: 8px;
            color: #2196F3;
        }

        .info-icon svg {
            width: 24px;
            height: 24px;
        }

        .loading {
            text-align: center;
            padding: 25px;
            color: #7f8c8d;
            font-size: 1rem;
        }

        .update-info {
            text-align: center;
            padding: 12px 20px;
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            font-size: 0.85rem;
            color: #1976D2;
            font-weight: 500;
            border-radius: 0 0 16px 16px;
        }

        .update-info .lucide {
            vertical-align: middle;
            margin-right: 6px;
            width: 16px;
            height: 16px;
        }

        /* Radar Content - Full Width */
        .radar-content {
            display: block;
        }

        .radar-wrapper {
            position: relative;
            background: #f8f9fa;
            overflow: hidden;
        }

        .radar-wrapper:first-child {
            border-radius: 0;
        }

        .radar-wrapper:last-child {
            border-right: none;
            border-radius: 0;
        }

        .map-container {
            width: 100%;
            height: 680px;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        /* Map */
        #mapid {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Map Controls - FIXED for proper button interaction */
        .map-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1002 !important;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            border: 1px solid rgba(33, 150, 243, 0.2);
            pointer-events: auto !important;
        }

        .timestamp-display {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #2c3e50;
            font-weight: 600;
            pointer-events: none;
        }

        .timestamp-display .lucide {
            color: #2196F3;
            width: 18px;
            height: 18px;
        }

        .forecast-badge {
            display: inline-block;
            background: linear-gradient(135deg, #FFA726 0%, #FF9800 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .playback-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: #2196F3;
            color: white;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            user-select: none;
            pointer-events: auto !important;
            position: relative;
            z-index: 1003 !important;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:hover {
            background: #1976D2;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .btn-icon {
            padding: 14px;
            min-width: 50px;
            min-height: 50px;
            justify-content: center;
            background: #2196F3;
        }

        .btn-icon:hover {
            background: #1976D2;
        }

        .btn-icon .lucide {
            width: 20px;
            height: 20px;
        }

        .btn-play {
            background: #4CAF50;
            min-height: 50px;
        }

        .btn-play:hover {
            background: #388E3C;
        }

        .btn-play .lucide {
            width: 18px;
            height: 18px;
        }

        /* Circle Labels */
        .circle-label {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            font-size: 0.9rem;
            font-weight: 700;
            text-shadow: 
                -1px -1px 0 #fff,
                1px -1px 0 #fff,
                -1px 1px 0 #fff,
                1px 1px 0 #fff,
                0 0 8px rgba(255, 255, 255, 0.9);
        }

        .circle-label.red {
            color: #ef4444 !important;
        }

        .circle-label.blue {
            color: #2196F3 !important;
        }

        /* Leaflet specific fixes - IMPORTANT for button interaction */
        .leaflet-container {
            z-index: 1 !important;
        }

        .leaflet-pane {
            z-index: auto !important;
        }

        .leaflet-tile-pane {
            z-index: 200 !important;
            transition: opacity 0.3s ease;
        }

        .leaflet-overlay-pane {
            z-index: 400 !important;
            transition: opacity 0.3s ease;
        }

        .leaflet-marker-pane {
            z-index: 600 !important;
        }

        /* Prevent map controls from interfering with buttons */
        .leaflet-control-container {
            pointer-events: none !important;
        }

        .leaflet-control {
            pointer-events: auto !important;
        }
        
        /* Smooth layer transitions */
        .leaflet-layer {
            transition: opacity 0.3s ease !important;
        }

        /* Custom Measurement Tool */
        .measure-control {
            position: absolute;
            top: 90px;
            left: 10px;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(33, 150, 243, 0.2);
        }

        .measure-btn {
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .measure-btn:hover {
            background-color: #E3F2FD;
        }

        .measure-btn.active {
            background-color: #2196F3;
        }

        .measure-btn svg {
            width: 20px;
            height: 20px;
            stroke: #2196F3;
        }

        .measure-btn.active svg {
            stroke: white;
        }

        #measure-clear-btn {
            background: #f44336;
        }

        #measure-clear-btn svg {
            stroke: white;
        }

        #measure-clear-btn:hover {
            background: #d32f2f;
        }

        .measure-toolbar {
            position: absolute;
            top: 50px;
            left: 10px;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(33, 150, 243, 0.2);
            display: none;
            gap: 10px;
            flex-direction: column;
            min-width: 200px;
        }

        .measure-toolbar.active {
            display: flex;
        }

        .measure-info {
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            color: #2c3e50;
            font-weight: 600;
            padding: 8px 12px;
            background: #E3F2FD;
            border-radius: 6px;
            text-align: center;
        }

        .measure-actions {
            display: flex;
            gap: 8px;
        }

        .measure-action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-width: 90px;
        }

        .measure-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .measure-finish {
            background: #4CAF50;
            color: white;
        }

        .measure-finish:hover {
            background: #388E3C;
        }

        .measure-cancel {
            background: #f44336;
            color: white;
        }

        .measure-cancel:hover {
            background: #d32f2f;
        }

        .measure-calculate {
            background: #FF9800;
            color: white;
        }

        .measure-calculate:hover {
            background: #F57C00;
        }

        .measure-instruction {
            font-size: 0.8rem;
            color: #7f8c8d;
            text-align: center;
            padding: 4px 8px;
        }

        /* Measurement markers */
        .measure-marker {
            width: 12px;
            height: 12px;
            background: #2196F3;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .measure-marker-first {
            width: 14px;
            height: 14px;
            background: #4CAF50;
        }

        /* Distance label */
        .measure-label {
            background: rgba(33, 150, 243, 0.95);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            border: 2px solid white;
        }

        .measure-total-label {
            background: rgba(76, 175, 80, 0.95);
        }

        /* Calculator Modal */
        .calc-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .calc-modal.active {
            display: flex;
        }

        .calc-modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .calc-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .calc-modal-header h3 {
            font-family: 'Inter', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .calc-modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: #f5f7fa;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .calc-modal-close:hover {
            background: #e9ecef;
        }

        .calc-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            background: #f5f7fa;
            padding: 5px;
            border-radius: 10px;
        }

        .calc-tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calc-tab.active {
            background: white;
            color: #2196F3;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calc-panel {
            display: none;
        }

        .calc-panel.active {
            display: block;
        }

        .calc-input-group {
            margin-bottom: 20px;
        }

        .calc-label {
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            display: block;
        }

        .calc-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: #2c3e50;
            transition: all 0.2s ease;
        }

        .calc-input:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .calc-input-suffix {
            position: relative;
        }

        .calc-input-suffix input {
            padding-right: 60px;
        }

        .calc-input-suffix-text {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            color: #7f8c8d;
            font-weight: 600;
        }

        .calc-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            background: #2196F3;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .calc-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .calc-result {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .calc-result.active {
            display: block;
        }

        .calc-result-label {
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            color: #1976D2;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .calc-result-value {
            font-family: 'Inter', sans-serif;
            font-size: 2rem;
            color: #0D47A1;
            font-weight: 700;
        }

        .calc-result-details {
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            color: #1976D2;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(33, 150, 243, 0.2);
        }

        .calc-info {
            background: #FFF3E0;
            border-left: 4px solid #FF9800;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .calc-info-text {
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            color: #E65100;
            line-height: 1.5;
        }

        /* METAR Raw Text */
        .metar-raw-content {
            padding: 20px 25px;
            background: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #2c3e50;
            white-space: pre-wrap;
            word-break: break-word;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        /* Responsive */
        @media (max-width: 1500px) {
            .map-container {
                height: 600px !important;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                height: 70px;
                padding: 0 1rem;
            }

            .navbar-brand .logo {
                width: 45px;
                height: 45px;
                font-size: 1.5rem;
            }

            .navbar-brand .title h1 {
                font-size: 1.2rem;
            }

            .current-time {
                font-size: 0.95rem;
                padding: 6px 12px;
            }

            .main-container {
                margin-top: 90px;
                padding: 12px;
            }

            .metar-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .chart-container {
                width: 110px;
                height: 110px;
            }

            .info-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .map-container {
                height: 500px !important;
            }

            .btn-icon {
                padding: 12px;
                min-width: 46px;
                min-height: 46px;
            }

            .btn-play {
                min-height: 46px;
                padding: 10px 16px;
            }

            .map-controls {
                padding: 12px 16px;
            }

            .calc-modal-content {
                width: 95%;
                padding: 20px;
            }

            .calc-tabs {
                flex-direction: column;
            }

            .calc-tab {
                font-size: 0.85rem;
            }

            .calc-modal-header h3 {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
    <div class="navbar-brand">
        <div class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 32px; height: 32px;">
                <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/>
            </svg>
        </div>
        <div class="title">
            <h1>Weather Radar System</h1>
        </div>
    </div>
    <div class="current-time">
        <svg xmlns="http://www.w3.org/2000/svg" class="lucide" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        <span id="current-time-display">--:--:--</span>
    </div>
</nav>

<!-- Main Container -->
<div class="main-container">
    <!-- METAR Section -->
    <div class="card">
        <div class="card-header">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" class="lucide" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>
                ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (METAR) - VTUD
            </h2>
        </div>

        <div class="card-body">
            <div id="metar-loading" class="loading">
                <svg xmlns="http://www.w3.org/2000/svg" class="lucide" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" style="animation: spin 1s linear infinite; width: 24px; height: 24px;"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®...
            </div>
            
            <!-- Charts Grid -->
            <div id="metar-charts" class="metar-grid" style="display: none;">
                <div class="metar-chart-card">
                    <div class="chart-container">
                        <canvas id="tempChart"></canvas>
                    </div>
                    <div class="chart-label">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</div>
                    <div class="chart-value" id="temp-display">--<span class="chart-unit">¬∞C</span></div>
                </div>

                <div class="metar-chart-card">
                    <div class="chart-container">
                        <canvas id="humidityChart"></canvas>
                    </div>
                    <div class="chart-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô</div>
                    <div class="chart-value" id="humidity-display">--<span class="chart-unit">%</span></div>
                </div>

                <div class="metar-chart-card">
                    <div class="chart-container">
                        <canvas id="pressureChart"></canvas>
                    </div>
                    <div class="chart-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</div>
                    <div class="chart-value" id="pressure-display">--<span class="chart-unit">hPa</span></div>
                </div>

                <div class="metar-chart-card">
                    <div class="chart-container">
                        <canvas id="windChart"></canvas>
                    </div>
                    <div class="chart-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏°</div>
                    <div class="chart-value" id="wind-display">--<span class="chart-unit">kt</span></div>
                </div>
            </div>

            <!-- Additional Info -->
            <div id="metar-info" class="info-grid" style="display: none;">
                <div class="info-card">
                    <div class="info-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                    </div>
                    <div class="info-label">‡∏à‡∏∏‡∏î‡∏ô‡πâ‡∏≥‡∏Ñ‡πâ‡∏≤‡∏á</div>
                    <div class="info-value" id="dewpoint-value">--¬∞C</div>
                </div>
                <div class="info-card">
                    <div class="info-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 10"/></svg>
                    </div>
                    <div class="info-label">‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏°</div>
                    <div class="info-value" id="wind-dir-value">--</div>
                </div>
                <div class="info-card">
                    <div class="info-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                    </div>
                    <div class="info-label">‡∏ó‡∏±‡∏®‡∏ô‡∏ß‡∏¥‡∏™‡∏±‡∏¢</div>
                    <div class="info-value" id="visibility-value">--</div>
                </div>
            </div>
        </div>

        <div class="update-info">
            <svg xmlns="http://www.w3.org/2000/svg" class="lucide" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-2.12-5.83"/><polyline points="21 3 21 12 12 12"/></svg>
            <span>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 30 ‡∏ô‡∏≤‡∏ó‡∏µ | ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: <span id="metar-countdown">--:--</span></span>
        </div>
    </div>

    <!-- Radar Section -->
    <div class="card">
        <div class="card-header">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" class="lucide" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                ‡πÄ‡∏£‡∏î‡∏≤‡∏£‡πå‡∏ù‡∏ô (Weather Radar)
            </h2>
        </div>

        <div class="radar-content">
            <!-- Live Radar -->
            <div class="radar-wrapper">
                <div class="map-container">
                    <div id="mapid">
                        <!-- Measurement Tool -->
                        <div class="measure-control">
                            <button class="measure-btn" id="measure-btn" title="‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"/>
                                    <path d="m14.5 12.5 2-2"/>
                                    <path d="m11.5 9.5 2-2"/>
                                    <path d="m8.5 6.5 2-2"/>
                                    <path d="m17.5 15.5 2-2"/>
                                </svg>
                            </button>
                        </div>
                        
                        <button class="measure-btn" id="measure-clear-btn" title="‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ß‡∏±‡∏î" style="position: absolute; top: 140px; left: 10px; z-index: 1000; display: none; background: #f44336;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="m19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                <line x1="10" y1="11" x2="10" y2="17"/>
                                <line x1="14" y1="11" x2="14" y2="17"/>
                            </svg>
                        </button>
                        
                        <div class="measure-toolbar" id="measure-toolbar">
                            <div class="measure-instruction">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏à‡∏∏‡∏î</div>
                            <div class="measure-info" id="measure-info">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: 0.00 ‡∏Å‡∏°.</div>
                            <div class="measure-actions">
                                <button class="measure-action-btn measure-finish" id="measure-finish">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    ‡πÄ‡∏™‡∏£‡πá‡∏à
                                </button>
                                <button class="measure-action-btn measure-cancel" id="measure-cancel">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                    </svg>
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                            </div>
                            <button class="measure-action-btn measure-calculate" id="measure-calculate" style="width: 100%; margin-top: 8px;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
                                    <rect x="4" y="2" width="16" height="20" rx="2"/>
                                    <line x1="8" y1="6" x2="16" y2="6"/>
                                    <line x1="16" y1="14" x2="16" y2="18"/>
                                    <path d="M16 10h.01"/>
                                    <path d="M12 10h.01"/>
                                    <path d="M8 10h.01"/>
                                    <path d="M12 14h.01"/>
                                    <path d="M8 14h.01"/>
                                    <path d="M12 18h.01"/>
                                    <path d="M8 18h.01"/>
                                </svg>
                                ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡∏ñ‡∏∂‡∏á
                            </button>
                        </div>
                        
                        <div class="map-controls">
                            <div id="timestamp" class="timestamp-display">
                                <svg xmlns="http://www.w3.org/2000/svg" class="lucide" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                <span id="timestamp-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                            </div>
                            <div class="playback-controls">
                                <button class="btn btn-icon" id="btn-prev" title="‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="lucide" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 19 2 12 11 5 11 19"/><polygon points="22 19 13 12 22 5 22 19"/></svg>
                                </button>
                                <button class="btn btn-play" id="btn-play" title="‡πÄ‡∏•‡πà‡∏ô/‡∏´‡∏¢‡∏∏‡∏î">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="lucide" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" id="play-icon-svg"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                    <span id="play-text">‡πÄ‡∏•‡πà‡∏ô</span>
                                </button>
                                <button class="btn btn-icon" id="btn-next" title="‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="lucide" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 19 22 12 13 5 13 19"/><polygon points="2 19 11 12 2 5 2 19"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="update-info">
            <svg xmlns="http://www.w3.org/2000/svg" class="lucide" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-2.12-5.83"/><polyline points="21 3 21 12 12 12"/></svg>
            <span>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 10 ‡∏ô‡∏≤‡∏ó‡∏µ | ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô: <span id="radar-countdown">--:--</span></span>
        </div>
    </div>

    <!-- METAR Raw Text Section -->
    <div class="card">
        <div class="card-header">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" class="lucide" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                ‡∏Ç‡πà‡∏≤‡∏ß METAR
            </h2>
        </div>
        <div class="card-body">
            <div class="metar-raw-content" id="metar-raw-text">
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• METAR...
            </div>
        </div>
        <div class="update-info">
            <svg xmlns="http://www.w3.org/2000/svg" class="lucide" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-2.12-5.83"/><polyline points="21 3 21 12 12 12"/></svg>
            <span>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 30 ‡∏ô‡∏≤‡∏ó‡∏µ | ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: <span id="metar-raw-countdown">--:--</span></span>
        </div>
    </div>
</div>

<!-- Calculator Modal -->
<div class="calc-modal" id="calc-modal">
    <div class="calc-modal-content">
        <div class="calc-modal-header">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 24px; height: 24px;">
                    <rect x="4" y="2" width="16" height="20" rx="2"/>
                    <line x1="8" y1="6" x2="16" y2="6"/>
                    <line x1="16" y1="14" x2="16" y2="18"/>
                    <path d="M16 10h.01"/>
                    <path d="M12 10h.01"/>
                    <path d="M8 10h.01"/>
                    <path d="M12 14h.01"/>
                    <path d="M8 14h.01"/>
                    <path d="M12 18h.01"/>
                    <path d="M8 18h.01"/>
                </svg>
                ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏Ü‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á
            </h3>
            <button class="calc-modal-close" id="calc-modal-close">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px;">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>

        <div class="calc-tabs">
            <button class="calc-tab active" data-tab="method1">‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà 1: ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á + ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</button>
            <button class="calc-tab" data-tab="method2">‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà 10 ‡∏ô‡∏≤‡∏ó‡∏µ</button>
        </div>

        <!-- Method 1: Distance + Wind Speed -->
        <div class="calc-panel active" id="calc-method1">
            <div class="calc-info">
                <p class="calc-info-text">‡πÉ‡∏™‡πà‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏°‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
            </div>

            <div class="calc-input-group">
                <label class="calc-label">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á</label>
                <div class="calc-input-suffix">
                    <input type="number" class="calc-input" id="method1-distance" placeholder="0.00" step="0.01" min="0">
                    <span class="calc-input-suffix-text">‡∏Å‡∏°.</span>
                </div>
            </div>

            <div class="calc-input-group">
                <label class="calc-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏°</label>
                <div class="calc-input-suffix">
                    <input type="number" class="calc-input" id="method1-speed" placeholder="0" step="1" min="0">
                    <span class="calc-input-suffix-text">‡∏Å‡∏°./‡∏ä‡∏°.</span>
                </div>
            </div>

            <button class="calc-btn" id="calc-method1-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px;">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
            </button>

            <div class="calc-result" id="calc-method1-result">
                <div class="calc-result-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏Ü‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</div>
                <div class="calc-result-value" id="calc-method1-value">--</div>
                <div class="calc-result-details" id="calc-method1-details"></div>
            </div>
        </div>

        <!-- Method 2: 10-minute Movement -->
        <div class="calc-panel" id="calc-method2">
            <div class="calc-info">
                <p class="calc-info-text">‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏Ü‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 10 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</p>
            </div>

            <div class="calc-input-group">
                <label class="calc-label">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏Ü‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô 10 ‡∏ô‡∏≤‡∏ó‡∏µ</label>
                <div class="calc-input-suffix">
                    <input type="number" class="calc-input" id="method2-movement" placeholder="0.00" step="0.01" min="0">
                    <span class="calc-input-suffix-text">‡∏Å‡∏°.</span>
                </div>
            </div>

            <div class="calc-input-group">
                <label class="calc-label">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                <div class="calc-input-suffix">
                    <input type="number" class="calc-input" id="method2-distance" placeholder="0.00" step="0.01" min="0">
                    <span class="calc-input-suffix-text">‡∏Å‡∏°.</span>
                </div>
            </div>

            <button class="calc-btn" id="calc-method2-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px;">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
            </button>

            <div class="calc-result" id="calc-method2-result">
                <div class="calc-result-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏Ü‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</div>
                <div class="calc-result-value" id="calc-method2-value">--</div>
                <div class="calc-result-details" id="calc-method2-details"></div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>

<script>
(function() {
    'use strict';
    
    // ==================== API Configuration ====================
    const API_CONFIG = {
        METAR: {
            endpoint: 'https://api.checkwx.com/metar/VTUD/decoded',
            key: 'd27b39a0a69e464c86bffd72dc',
            updateInterval: 30
        },
        RADAR: {
            rainviewer: 'https://api.rainviewer.com/public/weather-maps.json',
            reference: 'https://weather.tmd.go.th/kkn/kkn240Loop.gif',
            updateInterval: 10
        }
    };

    const UDON_THANI_AIRPORT = [17.3866, 102.7882];

    console.log('üöÄ Weather Radar System Starting...');

    // ==================== Utility Functions ====================
    function formatUpdateTime() {
        const now = new Date();
        return now.toLocaleString('th-TH', { 
            day: 'numeric',
            month: 'short',
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
        });
    }

    // ==================== Chart Configuration with New Colors ====================
    const chartColors = {
        temp: { 
            main: '#FF69B4',
            gradient: ['#FF69B4', '#FF8DC7'],
            bg: 'rgba(255, 105, 180, 0.08)' 
        },
        humidity: { 
            main: '#10B981',
            gradient: ['#10B981', '#34D399'],
            bg: 'rgba(16, 185, 129, 0.08)' 
        },
        pressure: { 
            main: '#A78BFA',
            gradient: ['#A78BFA', '#C4B5FD'],
            bg: 'rgba(167, 139, 250, 0.08)' 
        },
        wind: { 
            main: '#FFD93D',
            gradient: ['#FFD93D', '#FFE569'],
            bg: 'rgba(255, 217, 61, 0.08)' 
        }
    };

    let charts = {};
    let lastMetarValues = {
        temp: null,
        humidity: null,
        pressure: null,
        windSpeed: null
    };

    function createDonutChart(canvasId, value, max, colors) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        // Create gradient
        const gradient = ctx.createLinearGradient(0, 0, 0, 140);
        gradient.addColorStop(0, colors.gradient[0]);
        gradient.addColorStop(1, colors.gradient[1]);
        
        if (charts[canvasId]) {
            charts[canvasId].destroy();
        }
        
        charts[canvasId] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [value, max - value],
                    backgroundColor: [gradient, colors.bg],
                    borderWidth: 0,
                    borderRadius: 8
                }]
            },
            options: {
                cutout: '75%',
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                animation: {
                    animateRotate: true,
                    animateScale: false,
                    duration: 800,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }

    // ==================== Initialize Map ====================
    const map = L.map('mapid', {
        center: UDON_THANI_AIRPORT,
        zoom: 10,
        zoomControl: true,
        maxZoom: 22,
        preferCanvas: true,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        touchZoom: true,
        dragging: true,
        zoomAnimation: false,
        fadeAnimation: false,
        markerZoomAnimation: false,
        zoomSnap: 1,
        zoomDelta: 1
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap',
        maxZoom: 22,
        updateWhenIdle: true,
        updateWhenZooming: false,
        keepBuffer: 2
    }).addTo(map);

    // Force map invalidation
    function invalidateMap() {
        setTimeout(() => map.invalidateSize(), 100);
        setTimeout(() => map.invalidateSize(), 300);
        setTimeout(() => map.invalidateSize(), 500);
        setTimeout(() => map.invalidateSize(), 1000);
    }
    
    invalidateMap();
    
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            map.invalidateSize();
        }, 250);
    });
    
    window.addEventListener('load', () => invalidateMap());

    // Lock zoom level during operations to prevent flickering
    let targetZoom = 10;
    let targetCenter = UDON_THANI_AIRPORT;
    
    map.on('zoomstart', function() {
        if (isNavigating) {
            map.setZoom(targetZoom, { animate: false });
        }
    });
    
    map.on('movestart', function() {
        if (isNavigating) {
            map.panTo(targetCenter, { animate: false, duration: 0, noMoveStart: true });
        }
    });

    // ==================== Airport Marker ====================
    const airportIcon = L.divIcon({
        className: 'custom-airport-marker',
        html: '<div style="background: #2196F3; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4); border: 3px solid white;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg></div>',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
    });

    L.marker(UDON_THANI_AIRPORT, { icon: airportIcon }).addTo(map)
        .bindPopup('<div style="font-family: Inter, sans-serif; text-align: center;"><strong>Udon Thani International Airport</strong><br>VTUD</div>');

    // ==================== Circles ====================
    L.circle(UDON_THANI_AIRPORT, {
        color: '#ef4444',
        fillColor: '#ef4444',
        fillOpacity: 0.05,
        radius: 8000,
        weight: 2
    }).addTo(map);

    L.circle(UDON_THANI_AIRPORT, {
        color: '#2196F3',
        fillColor: '#2196F3',
        fillOpacity: 0.05,
        radius: 16000,
        weight: 2
    }).addTo(map);

    const radiusInDegrees16 = 16 / 111;
    L.polyline([
        [UDON_THANI_AIRPORT[0] + radiusInDegrees16, UDON_THANI_AIRPORT[1]],
        [UDON_THANI_AIRPORT[0] - radiusInDegrees16, UDON_THANI_AIRPORT[1]]
    ], { color: '#666', weight: 1, opacity: 0.5, dashArray: '5, 5' }).addTo(map);

    L.polyline([
        [UDON_THANI_AIRPORT[0], UDON_THANI_AIRPORT[1] - radiusInDegrees16],
        [UDON_THANI_AIRPORT[0], UDON_THANI_AIRPORT[1] + radiusInDegrees16]
    ], { color: '#666', weight: 1, opacity: 0.5, dashArray: '5, 5' }).addTo(map);

    function addCircleLabels() {
        const offset8 = 8 / 111;
        const offset16 = 16 / 111;
        
        const positions = [
            [offset8, 0, 'red', '8 km', [20, 10]],
            [-offset8, 0, 'red', '8 km', [-20, 10]],
            [0, offset8, 'red', '8 km', [-10, 20]],
            [0, -offset8, 'red', '8 km', [-10, -5]],
            [offset16, 0, 'blue', '16 km', [25, 10]],
            [-offset16, 0, 'blue', '16 km', [-25, 10]],
            [0, offset16, 'blue', '16 km', [-10, 25]],
            [0, -offset16, 'blue', '16 km', [-10, -5]]
        ];
        
        positions.forEach(pos => {
            const icon = L.divIcon({
                className: 'circle-label ' + pos[2],
                html: pos[3],
                iconSize: [50, 20],
                iconAnchor: pos[4]
            });
            L.marker([UDON_THANI_AIRPORT[0] + pos[0], UDON_THANI_AIRPORT[1] + pos[1]], { icon: icon }).addTo(map);
        });
    }
    addCircleLabels();

    L.Control.geocoder({ defaultMarkGeocode: false }).addTo(map);

    // ==================== Custom Measurement Tool ====================
    let isMeasuring = false;
    let measurePoints = [];
    let measureMarkers = [];
    let measureLines = [];
    let measureLabels = [];
    let totalDistance = 0;

    function formatDistance(meters) {
        if (meters < 1000) {
            return meters.toFixed(0) + ' ‡∏°.';
        } else {
            return (meters / 1000).toFixed(2) + ' ‡∏Å‡∏°.';
        }
    }

    function calculateDistance(latlng1, latlng2) {
        return map.distance(latlng1, latlng2);
    }

    function startMeasuring() {
        isMeasuring = true;
        measurePoints = [];
        totalDistance = 0;
        
        // Disable map dragging
        map.dragging.disable();
        map.doubleClickZoom.disable();
        
        // Update UI
        document.getElementById('measure-btn').classList.add('active');
        document.getElementById('measure-toolbar').classList.add('active');
        document.getElementById('measure-info').textContent = '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: 0.00 ‡∏Å‡∏°.';
        
        // Change cursor
        document.getElementById('mapid').style.cursor = 'crosshair';
        
        console.log('üìè Measurement started');
    }

    function stopMeasuring(save = false) {
        isMeasuring = false;
        
        // Enable map dragging
        map.dragging.enable();
        map.doubleClickZoom.enable();
        
        // Update UI
        document.getElementById('measure-btn').classList.remove('active');
        document.getElementById('measure-toolbar').classList.remove('active');
        
        // Reset cursor
        document.getElementById('mapid').style.cursor = '';
        
        if (!save) {
            // Clear all measurements
            clearMeasurements();
        } else if (measurePoints.length > 0) {
            // Keep the measurement but convert markers to permanent
            measureMarkers.forEach(marker => {
                marker.on('click', function() {
                    map.removeLayer(marker);
                });
            });
        }
        
        console.log('üìè Measurement stopped');
    }

    function clearMeasurements() {
        // Remove all markers
        measureMarkers.forEach(marker => map.removeLayer(marker));
        measureMarkers = [];
        
        // Remove all lines
        measureLines.forEach(line => map.removeLayer(line));
        measureLines = [];
        
        // Remove all labels
        measureLabels.forEach(label => map.removeLayer(label));
        measureLabels = [];
        
        measurePoints = [];
        totalDistance = 0;
    }

    function addMeasurePoint(latlng) {
        measurePoints.push(latlng);
        
        // Create marker
        const markerIcon = L.divIcon({
            className: measurePoints.length === 1 ? 'measure-marker measure-marker-first' : 'measure-marker',
            iconSize: [12, 12],
            iconAnchor: [6, 6]
        });
        
        const marker = L.marker(latlng, { icon: markerIcon }).addTo(map);
        measureMarkers.push(marker);
        
        // If we have more than one point, draw line and calculate distance
        if (measurePoints.length > 1) {
            const prevPoint = measurePoints[measurePoints.length - 2];
            const currPoint = latlng;
            
            // Draw line
            const line = L.polyline([prevPoint, currPoint], {
                color: '#2196F3',
                weight: 4,
                opacity: 0.8,
                dashArray: '10, 5',
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(map);
            measureLines.push(line);
            
            // Calculate segment distance
            const segmentDistance = calculateDistance(prevPoint, currPoint);
            totalDistance += segmentDistance;
            
            // Add distance label at midpoint
            const midLat = (prevPoint.lat + currPoint.lat) / 2;
            const midLng = (prevPoint.lng + currPoint.lng) / 2;
            
            const labelIcon = L.divIcon({
                className: 'measure-label',
                html: formatDistance(segmentDistance),
                iconSize: null,
                iconAnchor: [0, 0]
            });
            
            const label = L.marker([midLat, midLng], { icon: labelIcon }).addTo(map);
            measureLabels.push(label);
            
            // Update total distance display
            document.getElementById('measure-info').textContent = 
                '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°: ' + formatDistance(totalDistance);
        }
    }

    // Measure button click
    document.getElementById('measure-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (!isMeasuring) {
            startMeasuring();
        } else {
            stopMeasuring(false);
        }
    });

    // Finish button
    document.getElementById('measure-finish').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (measurePoints.length >= 2) {
            // Add total distance label
            const lastPoint = measurePoints[measurePoints.length - 1];
            const totalLabelIcon = L.divIcon({
                className: 'measure-label measure-total-label',
                html: 'üìè ‡∏£‡∏ß‡∏°: ' + formatDistance(totalDistance),
                iconSize: null,
                iconAnchor: [-10, -10]
            });
            
            const totalLabel = L.marker(lastPoint, { icon: totalLabelIcon }).addTo(map);
            measureLabels.push(totalLabel);
            
            stopMeasuring(true);
            
            // Show clear button
            document.getElementById('measure-clear-btn').style.display = 'block';
        }
    });

    // Cancel button
    document.getElementById('measure-cancel').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        stopMeasuring(false);
    });

    // Clear measurements button
    document.getElementById('measure-clear-btn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        clearMeasurements();
        this.style.display = 'none';
    });

    // Map click handler for measurement
    map.on('click', function(e) {
        if (isMeasuring) {
            addMeasurePoint(e.latlng);
        }
    });

    console.log('üìè Custom measurement tool initialized');

    // ==================== Calculator Modal ====================
    const calcModal = document.getElementById('calc-modal');
    const calcModalClose = document.getElementById('calc-modal-close');
    const calcCalculateBtn = document.getElementById('measure-calculate');
    const calcTabs = document.querySelectorAll('.calc-tab');
    const calcPanels = document.querySelectorAll('.calc-panel');

    // Open calculator modal
    calcCalculateBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Auto-fill distance if measurement exists
        if (totalDistance > 0) {
            const distanceKm = totalDistance / 1000;
            document.getElementById('method1-distance').value = distanceKm.toFixed(2);
            document.getElementById('method2-distance').value = distanceKm.toFixed(2);
        }
        
        calcModal.classList.add('active');
        console.log('üßÆ Calculator opened');
    });

    // Close calculator modal
    calcModalClose.addEventListener('click', function() {
        calcModal.classList.remove('active');
    });

    // Close on backdrop click
    calcModal.addEventListener('click', function(e) {
        if (e.target === calcModal) {
            calcModal.classList.remove('active');
        }
    });

    // Tab switching
    calcTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.dataset.tab;
            
            // Update tabs
            calcTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Update panels
            calcPanels.forEach(panel => {
                if (panel.id === `calc-${targetTab}`) {
                    panel.classList.add('active');
                } else {
                    panel.classList.remove('active');
                }
            });
        });
    });

    // Method 1: Distance + Wind Speed
    document.getElementById('calc-method1-btn').addEventListener('click', function() {
        const distance = parseFloat(document.getElementById('method1-distance').value);
        const speed = parseFloat(document.getElementById('method1-speed').value);
        
        if (!distance || !speed || distance <= 0 || speed <= 0) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            return;
        }
        
        // Calculate time = distance / speed (in hours)
        const timeHours = distance / speed;
        const timeMinutes = timeHours * 60;
        
        // Format result
        let resultText = '';
        if (timeHours >= 1) {
            const hours = Math.floor(timeHours);
            const minutes = Math.round((timeHours - hours) * 60);
            resultText = `${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        } else {
            resultText = `${Math.round(timeMinutes)} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        }
        
        // Display result
        document.getElementById('calc-method1-value').textContent = resultText;
        document.getElementById('calc-method1-details').innerHTML = 
            `<strong>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</strong> ${distance.toFixed(2)} ‡∏Å‡∏°.<br>` +
            `<strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏°:</strong> ${speed} ‡∏Å‡∏°./‡∏ä‡∏°.<br>` +
            `<strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</strong> ${timeMinutes.toFixed(1)} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        document.getElementById('calc-method1-result').classList.add('active');
        
        console.log(`üìä Method 1: ${distance}km at ${speed}km/h = ${resultText}`);
    });

    // Method 2: 10-minute Movement
    document.getElementById('calc-method2-btn').addEventListener('click', function() {
        const movement = parseFloat(document.getElementById('method2-movement').value);
        const distance = parseFloat(document.getElementById('method2-distance').value);
        
        if (!movement || !distance || movement <= 0 || distance <= 0) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            return;
        }
        
        // Calculate speed = distance / time (10 minutes = 1/6 hour)
        const speedKmPerHour = movement / (10 / 60);
        
        // Calculate time to reach destination
        const timeHours = distance / speedKmPerHour;
        const timeMinutes = timeHours * 60;
        
        // Format result
        let resultText = '';
        if (timeHours >= 1) {
            const hours = Math.floor(timeHours);
            const minutes = Math.round((timeHours - hours) * 60);
            resultText = `${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        } else {
            resultText = `${Math.round(timeMinutes)} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        }
        
        // Display result
        document.getElementById('calc-method2-value').textContent = resultText;
        document.getElementById('calc-method2-details').innerHTML = 
            `<strong>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà (10 ‡∏ô‡∏≤‡∏ó‡∏µ):</strong> ${movement.toFixed(2)} ‡∏Å‡∏°.<br>` +
            `<strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢:</strong> ${speedKmPerHour.toFixed(1)} ‡∏Å‡∏°./‡∏ä‡∏°.<br>` +
            `<strong>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</strong> ${distance.toFixed(2)} ‡∏Å‡∏°.<br>` +
            `<strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</strong> ${timeMinutes.toFixed(1)} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        document.getElementById('calc-method2-result').classList.add('active');
        
        console.log(`üìä Method 2: ${movement}km in 10min, ${distance}km remaining = ${resultText}`);
    });

    console.log('üßÆ Calculator initialized');

    // ==================== RainViewer Radar ====================
    let apiData = {};
    let mapFrames = [];
    let radarLayers = [];
    let animationPosition = 0;
    let animationTimer = false;
    let isPlaying = false;
    let loadingTilesCount = 0;
    let loadedTilesCount = 0;
    let pastFramesCount = 0;

    function startLoadingTile() { loadingTilesCount++; }
    function finishLoadingTile() { setTimeout(() => loadedTilesCount++, 250); }
    function isTilesLoading() { return loadingTilesCount > loadedTilesCount; }

    function loadRadarData() {
        console.log('üåßÔ∏è  Loading RainViewer data...');
        
        fetch(API_CONFIG.RADAR.rainviewer)
            .then(r => r.json())
            .then(data => {
                console.log('‚úÖ RainViewer data loaded!');
                
                apiData = data;
                initialize(data);
            })
            .catch(err => {
                console.error('‚ùå RainViewer Error:', err);
            });
    }

    function initialize(api) {
        stop();
        
        radarLayers.forEach(l => map.removeLayer(l));
        mapFrames = [];
        radarLayers = [];
        animationPosition = 0;

        if (api.radar && api.radar.past) {
            pastFramesCount = api.radar.past.length;
            mapFrames = api.radar.past.concat(api.radar.nowcast || []);
            const latestIndex = api.radar.past.length - 1;
            console.log('üéØ Latest frame:', latestIndex, '/ Past frames:', pastFramesCount);
            showFrame(latestIndex, true);
            animationPosition = latestIndex;
        }
    }

    function addLayer(frame) {
        if (!radarLayers[frame.path]) {
            const source = new L.TileLayer(
                apiData.host + frame.path + '/256/{z}/{x}/{y}/4/1_1.png',
                { 
                    tileSize: 256, 
                    opacity: 0.01, 
                    zIndex: frame.time, 
                    maxZoom: 22,
                    maxNativeZoom: 8,
                    minZoom: 0,
                    keepBuffer: 10,
                    updateWhenZooming: false,
                    updateWhenIdle: true
                }
            );
            source.on('loading', startLoadingTile);
            source.on('load', finishLoadingTile);
            radarLayers[frame.path] = source;
        }
        if (!map.hasLayer(radarLayers[frame.path])) {
            map.addLayer(radarLayers[frame.path]);
        }
    }

    function changeRadarPosition(position, preloadOnly, force) {
        while (position >= mapFrames.length) position -= mapFrames.length;
        while (position < 0) position += mapFrames.length;

        const currentFrame = mapFrames[animationPosition];
        const nextFrame = mapFrames[position];
        addLayer(nextFrame);

        if (preloadOnly || (isTilesLoading() && !force)) return;

        animationPosition = position;
        
        // Smooth opacity transitions
        if (radarLayers[currentFrame.path]) {
            const currentLayer = radarLayers[currentFrame.path].getContainer();
            if (currentLayer) {
                currentLayer.style.transition = 'opacity 0.3s ease';
            }
            radarLayers[currentFrame.path].setOpacity(0);
        }
        
        const nextLayer = radarLayers[nextFrame.path].getContainer();
        if (nextLayer) {
            nextLayer.style.transition = 'opacity 0.3s ease';
        }
        radarLayers[nextFrame.path].setOpacity(0.7);

        // Update timestamp
        const date = new Date(nextFrame.time * 1000);
        const timeStr = date.toLocaleString('th-TH', { 
            day: 'numeric',
            month: 'short',
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
        });
        
        // Check if this is a forecast frame (nowcast)
        const isForecast = position >= pastFramesCount;
        
        const timestampElement = document.getElementById('timestamp-text');
        if (isForecast) {
            timestampElement.innerHTML = timeStr + '<span class="forecast-badge">‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå</span>';
        } else {
            timestampElement.innerHTML = timeStr;
        }
    }

    function showFrame(nextPosition, force) {
        // Store current view state
        const currentZoom = map.getZoom();
        const currentCenter = map.getCenter();
        
        // Update target values
        targetZoom = currentZoom;
        targetCenter = currentCenter;
        
        changeRadarPosition(nextPosition, false, force);
        changeRadarPosition(nextPosition + (nextPosition > animationPosition ? 1 : -1), true);
        
        // Gently restore view state only if it changed significantly
        const newZoom = map.getZoom();
        const newCenter = map.getCenter();
        
        if (newZoom !== currentZoom || 
            Math.abs(newCenter.lat - currentCenter.lat) > 0.0001 || 
            Math.abs(newCenter.lng - currentCenter.lng) > 0.0001) {
            
            // Use flyTo for smoother transition if needed, or instant setView
            map.setView(currentCenter, currentZoom, { 
                animate: false,
                duration: 0,
                noMoveStart: true
            });
        }
    }

    function stop() {
        if (animationTimer) {
            clearTimeout(animationTimer);
            animationTimer = false;
            isPlaying = false;
            updatePlayButton();
            return true;
        }
        return false;
    }

    function play() {
        showFrame(animationPosition + 1);
        animationTimer = setTimeout(play, 500);
        isPlaying = true;
        updatePlayButton();
    }

    function playStop() {
        if (!stop()) play();
    }

    function updatePlayButton() {
        const iconSvg = document.getElementById('play-icon-svg');
        const text = document.getElementById('play-text');
        
        if (isPlaying) {
            iconSvg.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
            text.textContent = '‡∏´‡∏¢‡∏∏‡∏î';
        } else {
            iconSvg.innerHTML = '<polygon points="5 3 19 12 5 21 5 3"/>';
            text.textContent = '‡πÄ‡∏•‡πà‡∏ô';
        }
    }

    // ==================== Button Event Handlers - SMOOTH & NO FLICKER ====================
    let isNavigating = false;
    
    function handleNavigation(direction) {
        if (isNavigating) return;
        isNavigating = true;
        
        // Store current view state
        targetZoom = map.getZoom();
        targetCenter = map.getCenter();
        
        // Use requestAnimationFrame for smooth updates
        requestAnimationFrame(() => {
            if (direction === 'prev') {
                showFrame(animationPosition - 1);
            } else if (direction === 'next') {
                showFrame(animationPosition + 1);
            }
            
            // Restore view immediately after frame change
            requestAnimationFrame(() => {
                if (map.getZoom() !== targetZoom || 
                    Math.abs(map.getCenter().lat - targetCenter.lat) > 0.0001 || 
                    Math.abs(map.getCenter().lng - targetCenter.lng) > 0.0001) {
                    map.setView(targetCenter, targetZoom, { 
                        animate: false,
                        duration: 0
                    });
                }
                
                // Release lock after a short delay
                setTimeout(() => {
                    isNavigating = false;
                }, 100);
            });
        });
    }

    document.getElementById('btn-prev').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        stop();
        handleNavigation('prev');
        console.log('‚¨ÖÔ∏è Previous frame');
        return false;
    }, true);

    document.getElementById('btn-next').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        stop();
        handleNavigation('next');
        console.log('‚û°Ô∏è Next frame');
        return false;
    }, true);

    document.getElementById('btn-play').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        playStop();
        console.log('‚ñ∂Ô∏è Play/Pause');
        return false;
    }, true);

    // Keyboard shortcuts
    document.onkeydown = function(e) {
        // Close calculator modal on ESC
        if (e.keyCode === 27 && calcModal.classList.contains('active')) {
            calcModal.classList.remove('active');
            e.preventDefault();
            return;
        }
        
        // Don't trigger shortcuts when calculator is open
        if (calcModal.classList.contains('active')) {
            return;
        }
        
        switch (e.keyCode) {
            case 37: 
                stop(); 
                handleNavigation('prev');
                e.preventDefault();
                break;
            case 39: 
                stop(); 
                handleNavigation('next');
                e.preventDefault();
                break;
            case 32: 
                playStop(); 
                e.preventDefault();
                break;
        }
    };

    // ==================== Countdown Timers ====================
    function calculateNextUpdateTime(intervalMinutes) {
        const now = new Date();
        const currentMinutes = now.getMinutes();
        const currentSeconds = now.getSeconds();
        
        const nextMinutes = Math.ceil((currentMinutes + 1) / intervalMinutes) * intervalMinutes;
        let minutesUntilNext = nextMinutes - currentMinutes;
        
        if (nextMinutes >= 60) {
            minutesUntilNext = 60 - currentMinutes;
        }
        
        const secondsUntilNext = (minutesUntilNext * 60) - currentSeconds;
        
        return secondsUntilNext;
    }

    // Radar Countdown
    let radarRemainingSeconds = calculateNextUpdateTime(API_CONFIG.RADAR.updateInterval);

    function startRadarCountdown() {
        setInterval(() => {
            radarRemainingSeconds--;
            if (radarRemainingSeconds <= 0) {
                console.log('üîÑ Auto-refresh radar...');
                loadRadarData();
                radarRemainingSeconds = calculateNextUpdateTime(API_CONFIG.RADAR.updateInterval);
            }
            const m = Math.floor(radarRemainingSeconds / 60);
            const s = radarRemainingSeconds % 60;
            document.getElementById('radar-countdown').textContent = m + ':' + (s < 10 ? '0' : '') + s;
        }, 1000);
    }

    // ==================== METAR API with Smart UI ====================
    function fetchMetar() {
        console.log('‚òÅÔ∏è  Fetching METAR...');
        
        fetch(API_CONFIG.METAR.endpoint, {
            headers: { 'X-API-Key': API_CONFIG.METAR.key }
        })
        .then(r => r.json())
        .then(data => {
            console.log('‚úÖ METAR received');
            if (data.data && data.data[0]) {
                displayMetar(data.data[0]);
            } else {
                displayMetar(null);
            }
        })
        .catch(err => {
            console.error('‚ùå METAR Error:', err);
            displayMetar(null);
        });
    }

    function displayMetar(metar) {
        document.getElementById('metar-loading').style.display = 'none';
        document.getElementById('metar-charts').style.display = 'grid';
        document.getElementById('metar-info').style.display = 'grid';

        const rawTextElement = document.getElementById('metar-raw-text');
        if (metar && metar.raw_text) {
            rawTextElement.textContent = metar.raw_text;
        } else {
            rawTextElement.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• METAR';
        }

        if (!metar) {
            document.getElementById('temp-display').innerHTML = '--<span class="chart-unit">¬∞C</span>';
            document.getElementById('humidity-display').innerHTML = '--<span class="chart-unit">%</span>';
            document.getElementById('pressure-display').innerHTML = '--<span class="chart-unit">hPa</span>';
            document.getElementById('wind-display').innerHTML = '--<span class="chart-unit">kt</span>';
            document.getElementById('dewpoint-value').textContent = '--¬∞C';
            document.getElementById('wind-dir-value').textContent = '--';
            document.getElementById('visibility-value').textContent = '--';
            return;
        }

        const temp = metar.temperature?.celsius || 0;
        const humidity = metar.humidity?.percent || 0;
        const pressure = metar.barometer?.hpa || 1013;
        const windSpeed = metar.wind?.speed_kts || 0;

        // Smart UI - Only update charts if values actually changed
        if (lastMetarValues.temp !== temp) {
            document.getElementById('temp-display').innerHTML = temp + '<span class="chart-unit">¬∞C</span>';
            createDonutChart('tempChart', temp, 50, chartColors.temp);
            lastMetarValues.temp = temp;
            console.log('üìä Updated temperature chart');
        }

        if (lastMetarValues.humidity !== humidity) {
            document.getElementById('humidity-display').innerHTML = humidity + '<span class="chart-unit">%</span>';
            createDonutChart('humidityChart', humidity, 100, chartColors.humidity);
            lastMetarValues.humidity = humidity;
            console.log('üìä Updated humidity chart');
        }

        if (lastMetarValues.pressure !== pressure) {
            document.getElementById('pressure-display').innerHTML = pressure + '<span class="chart-unit">hPa</span>';
            createDonutChart('pressureChart', pressure - 950, 100, chartColors.pressure);
            lastMetarValues.pressure = pressure;
            console.log('üìä Updated pressure chart');
        }

        if (lastMetarValues.windSpeed !== windSpeed) {
            document.getElementById('wind-display').innerHTML = windSpeed + '<span class="chart-unit">kt</span>';
            createDonutChart('windChart', windSpeed, 50, chartColors.wind);
            lastMetarValues.windSpeed = windSpeed;
            console.log('üìä Updated wind chart');
        }

        document.getElementById('dewpoint-value').textContent = (metar.dewpoint?.celsius || '--') + '¬∞C';
        document.getElementById('wind-dir-value').textContent = metar.wind?.degrees ? metar.wind.degrees + '¬∞' : 'VRB';
        
        const visibility = metar.visibility?.meters_float;
        if (visibility >= 10000) {
            document.getElementById('visibility-value').textContent = '>10 km';
        } else if (visibility) {
            document.getElementById('visibility-value').textContent = (visibility / 1000).toFixed(1) + ' km';
        } else {
            document.getElementById('visibility-value').textContent = '--';
        }
    }

    // METAR Countdown (30 minutes for both METAR sections)
    let metarRemainingSeconds = calculateNextUpdateTime(API_CONFIG.METAR.updateInterval);

    function startMetarCountdown() {
        setInterval(() => {
            metarRemainingSeconds--;
            if (metarRemainingSeconds <= 0) {
                console.log('üîÑ Auto-refresh METAR...');
                fetchMetar();
                metarRemainingSeconds = calculateNextUpdateTime(API_CONFIG.METAR.updateInterval);
            }
            const m = Math.floor(metarRemainingSeconds / 60);
            const s = metarRemainingSeconds % 60;
            const timeStr = m + ':' + (s < 10 ? '0' : '') + s;
            document.getElementById('metar-countdown').textContent = timeStr;
            document.getElementById('metar-raw-countdown').textContent = timeStr;
        }, 1000);
    }

    // ==================== Current Time ====================
    function updateCurrentTime() {
        document.getElementById('current-time-display').textContent = 
            new Date().toLocaleString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    }
    setInterval(updateCurrentTime, 1000);

    // ==================== Initialize ====================
    console.log('üé¨ Starting all systems...');
    
    loadRadarData();
    startRadarCountdown();
    
    fetchMetar();
    startMetarCountdown();
    
    updateCurrentTime();
    
    console.log('‚úÖ System ready!');
})();
</script>

</body>
</html>
