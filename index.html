<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ติดตามรถ - Advanced GPS Filter</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 0;
            color: #1a202c;
            overflow-x: hidden;
        }

        .top-bar {
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            padding: 16px 20px;
            box-shadow: 0 4px 20px rgba(14, 165, 233, 0.15);
        }

        .top-bar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-icon {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .app-name {
            color: white;
        }

        .app-name h1 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 2px;
            letter-spacing: -0.3px;
        }

        .app-name p {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 500;
        }

        .notification-badge {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .notification-badge:active {
            transform: scale(0.95);
        }

        .notification-dot {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            border: 2px solid #0ea5e9;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        .status-banner {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #bae6fd;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 4px 16px rgba(14, 165, 233, 0.08);
        }

        .status-icon {
            width: 56px;
            height: 56px;
            background: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
        }

        .status-icon.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            animation: pulse-green 2s infinite;
        }

        .status-icon.inactive {
            background: #f1f5f9;
        }

        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(16, 185, 129, 0.5); }
        }

        .status-content h3 {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-content p {
            font-size: 20px;
            font-weight: 700;
            color: #1a202c;
        }

        .status-content p.active {
            color: #10b981;
        }

        .status-content p.inactive {
            color: #64748b;
        }

        .section {
            background: white;
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.04);
            border: 1px solid #f1f5f9;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 700;
            color: #1a202c;
        }

        .section-title-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1e40af;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            pointer-events: none;
        }

        .form-input {
            width: 100%;
            padding: 16px 16px 16px 48px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 500;
            color: #1a202c;
            background: #f8fafc;
            transition: all 0.3s;
            outline: none;
        }

        .form-input:focus {
            background: white;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
        }

        .form-input:disabled {
            background: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
        }

        .stat-card:active {
            transform: scale(0.98);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .stat-label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .stat-icon-small {
            width: 28px;
            height: 28px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 800;
            color: #1a202c;
            line-height: 1;
        }

        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: white;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .stat-badge.active {
            background: #d1fae5;
            color: #065f46;
        }

        .stat-badge.inactive {
            background: white;
            color: #64748b;
        }

        .stat-badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .stat-badge.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .map-container {
            height: 280px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 12px;
            right: 12px;
            background: white;
            padding: 8px 14px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            backdrop-filter: blur(10px);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 24px;
            border: none;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-start {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-start:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .btn-stop {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-stop:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-save {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            color: white;
            box-shadow: 0 8px 24px rgba(14, 165, 233, 0.3);
        }

        .btn-save:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .alert {
            display: none;
            padding: 16px 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 600;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .alert-success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 2px solid #10b981;
        }

        .alert-error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 2px solid #ef4444;
        }

        .alert-info {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border: 2px solid #3b82f6;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 2px solid #f59e0b;
        }

        .location-display {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
        }

        .location-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .location-info {
            flex: 1;
            min-width: 0;
        }

        .location-label {
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .location-value {
            font-size: 13px;
            font-weight: 600;
            color: #1a202c;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .timestamp {
            text-align: center;
            padding: 12px;
            color: #94a3b8;
            font-size: 12px;
            font-weight: 500;
        }

        .pulse-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: currentColor;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1);
            }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .status-icon.active svg {
            animation: float 3s ease-in-out infinite;
        }

        .filter-status {
            background: #f1f5f9;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
        }

        .filter-status.skipped {
            background: #fef3c7;
            border-color: #fde68a;
            color: #92400e;
        }

        .filter-status.smoothed {
            background: #dbeafe;
            border-color: #bfdbfe;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="top-bar-content">
            <div class="app-title">
                <div class="app-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></svg>
                </div>
                <div class="app-name">
                    <h1>Vehicle Tracker Pro</h1>
                    <p>Advanced Filter • 3s Updates</p>
                </div>
            </div>
            <div class="notification-badge">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                <div class="notification-dot"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="alert alert-success" id="alertSuccess">
            <div class="alert-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </div>
            <span id="successMessage"></span>
        </div>

        <div class="alert alert-error" id="alertError">
            <div class="alert-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></svg>
            </div>
            <span id="errorMessage"></span>
        </div>

        <div class="alert alert-info" id="alertInfo">
            <div class="alert-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>
            </div>
            <span id="infoMessage"></span>
        </div>

        <div class="alert alert-warning" id="alertWarning">
            <div class="alert-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>
            </div>
            <span id="warningMessage"></span>
        </div>

        <div class="status-banner">
            <div class="status-icon inactive" id="statusIcon">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color: #94a3b8;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </div>
            <div class="status-content">
                <h3>Tracking Status</h3>
                <p class="inactive" id="trackingStatus">ไม่ได้ติดตาม</p>
            </div>
        </div>

        <div class="filter-status" id="filterStatus" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
            <span id="filterStatusText">กำลังกรองและ smooth GPS...</span>
        </div>

        <div class="section">
            <div class="section-header">
                <div class="section-title">
                    <div class="section-title-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                    </div>
                    รายละเอียดรถ
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></svg>
                    ประเภทรถ
                </label>
                <div class="input-wrapper">
                    <div class="input-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></svg>
                    </div>
                    <input type="text" id="vehicleType" class="form-input" placeholder="รถบรรทุก, รถตู้, รถเก๋ง">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    หมายเลขทะเบียน
                </label>
                <div class="input-wrapper">
                    <div class="input-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <input type="text" id="licensePlate" class="form-input" placeholder="กข 1234 กรุงเทพ">
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <div class="section-title">
                    <div class="section-title-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                    </div>
                    สถิติการติดตาม
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">จุดบันทึก</span>
                        <div class="stat-icon-small">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #0ea5e9;"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                        </div>
                    </div>
                    <div class="stat-value" id="pointCount">0</div>
                    <div class="stat-badge inactive">
                        <span class="pulse-dot"></span>
                        Smoothed Data
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">GPS Quality</span>
                        <div class="stat-icon-small">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #059669;"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                        </div>
                    </div>
                    <div class="stat-value" id="gpsAccuracy">--</div>
                    <div class="stat-badge inactive" id="gpsQualityBadge">
                        <span class="pulse-dot"></span>
                        Checking...
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">Speed</span>
                        <div class="stat-icon-small">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #3b82f6;"><path d="m3 17 7-7 4 4 8-8"/><path d="m14 6 4-1 1 4"/></svg>
                        </div>
                    </div>
                    <div class="stat-value" id="speedValue">0</div>
                    <div class="stat-badge inactive" id="speedBadge">
                        <span class="pulse-dot"></span>
                        km/h
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-label">Firebase</span>
                        <div class="stat-icon-small">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #10b981;"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
                        </div>
                    </div>
                    <div class="stat-value">3s</div>
                    <div class="stat-badge inactive" id="firebaseBadge">
                        <span class="pulse-dot"></span>
                        ไม่ทำงาน
                    </div>
                </div>
            </div>

            <div class="location-display">
                <div class="location-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 11l18-5v12L3 14v-3z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/></svg>
                </div>
                <div class="location-info">
                    <div class="location-label">พิกัดปัจจุบัน (Smoothed)</div>
                    <div class="location-value" id="currentLocation">รอข้อมูล GPS...</div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            <div class="map-overlay">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 4px;"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>
                Advanced Tracking
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-start" id="startBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                เริ่มติดตาม
            </button>
            <button class="btn btn-stop" id="stopBtn" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="4" height="16" x="6" y="4"/><rect width="4" height="16" x="14" y="4"/></svg>
                หยุด
            </button>
            <button class="btn btn-save" id="saveBtn" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                บันทึกประวัติการเดินทาง
            </button>
        </div>

        <div class="timestamp" id="lastUpdate">
            อัปเดทล่าสุด: <span style="font-weight: 600;">-</span>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
const firebaseConfig = {
  apiKey: "AIzaSyDczlfTJc4hI5BD9-utiOmGEdx1es38ya0",
  authDomain: "telematic-f6a5a.firebaseapp.com",
  databaseURL: "https://telematic-f6a5a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "telematic-f6a5a",
  storageBucket: "telematic-f6a5a.firebasestorage.app",
  messagingSenderId: "426976429007",
  appId: "1:426976429007:web:64e3abfce2dcc6d5c788ba",
  measurementId: "G-JWG01H8DGH"
};

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzw7AKriFwVprlxjvvoSCIs0RxPuaZ0rj9Hch9jeHjbFwqPtwZ5xFPR_i18V_bOTFM/exec';

        // ✅ Advanced GPS Filter Parameters
        const MIN_SPEED = 0.5;          // m/s (1.8 km/h)
        const MIN_DISTANCE = 8;         // เมตร
        const MAX_ACCURACY = 50;        // เมตร
        const MAX_SPEED = 55.56;        // 200 km/h in m/s (outlier detection)
        const EMA_ALPHA = 0.3;          // Exponential Moving Average smoothing factor (0-1)
        const POSITION_HISTORY_SIZE = 5; // จำนวนตำแหน่งที่เก็บไว้สำหรับ smoothing

        let map;
        let marker;
        let polyline;
        let isTracking = false;
        let currentRoute = [];
        let lastPosition = null;
        let lastRecordedPosition = null;
        
        // ✅ เปลี่ยนเป็น 3 วินาที
        const FIREBASE_INTERVAL = 3000;   // 3 seconds
        const LOCAL_STORAGE_INTERVAL = 3000; // 3 seconds
        let localStorageTimer = null;
        let firebaseTimer = null;
        
        let skippedPoints = 0;
        let totalChecks = 0;
        let smoothedPoints = 0;

        // ✅ Position history for advanced smoothing
        let positionHistory = [];
        let emaLat = null;
        let emaLon = null;

        function initMap() {
            map = L.map('map').setView([13.7563, 100.5018], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);

            const customIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="width: 32px; height: 32px; background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4); border: 3px solid white;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg></div>',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            marker = L.marker([13.7563, 100.5018], { icon: customIcon }).addTo(map);
            
            polyline = L.polyline([], {
                color: '#0ea5e9',
                weight: 4,
                opacity: 0.8,
                smoothFactor: 1
            }).addTo(map);
        }

        function loadLocalData() {
            const saved = localStorage.getItem('currentRoute');
            if (saved) {
                currentRoute = JSON.parse(saved);
                if (currentRoute.length > 0) {
                    lastRecordedPosition = {
                        lat: currentRoute[currentRoute.length - 1].latitude,
                        lon: currentRoute[currentRoute.length - 1].longitude
                    };
                    
                    // Initialize EMA with last recorded position
                    emaLat = lastRecordedPosition.lat;
                    emaLon = lastRecordedPosition.lon;
                }
                updatePointCount();
                
                if (currentRoute.length > 0) {
                    const lastPoint = currentRoute[currentRoute.length - 1];
                    updateMap(lastPoint.latitude, lastPoint.longitude);
                    polyline.setLatLngs(currentRoute.map(p => [p.latitude, p.longitude]));
                }
            }

            const vehicleType = localStorage.getItem('vehicleType');
            const licensePlate = localStorage.getItem('licensePlate');
            
            if (vehicleType) document.getElementById('vehicleType').value = vehicleType;
            if (licensePlate) document.getElementById('licensePlate').value = licensePlate;
        }

        function updateMap(lat, lng) {
            const newLatLng = [lat, lng];
            marker.setLatLng(newLatLng);
            map.setView(newLatLng, 16);
        }

        function updatePointCount() {
            document.getElementById('pointCount').textContent = currentRoute.length;
            document.getElementById('saveBtn').disabled = currentRoute.length === 0 || isTracking;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // ✅ Exponential Moving Average (EMA) Smoothing
        function applyEMA(currentLat, currentLon, accuracy) {
            if (emaLat === null || emaLon === null) {
                emaLat = currentLat;
                emaLon = currentLon;
                return { lat: currentLat, lon: currentLon };
            }

            // ปรับ alpha ตาม accuracy (accuracy ดี = ให้น้ำหนักมากกับข้อมูลใหม่)
            const adaptiveAlpha = accuracy < 15 ? 0.5 : (accuracy < 30 ? 0.3 : 0.2);
            
            emaLat = adaptiveAlpha * currentLat + (1 - adaptiveAlpha) * emaLat;
            emaLon = adaptiveAlpha * currentLon + (1 - adaptiveAlpha) * emaLon;

            return { lat: emaLat, lon: emaLon };
        }

        // ✅ Accuracy-Weighted Average (ใช้ตำแหน่งที่แม่นยำสูงมากกว่า)
        function accuracyWeightedSmoothing(currentLat, currentLon, accuracy) {
            positionHistory.push({ lat: currentLat, lon: currentLon, acc: accuracy, time: Date.now() });

            // เก็บแค่ N ตำแหน่งล่าสุด
            if (positionHistory.length > POSITION_HISTORY_SIZE) {
                positionHistory.shift();
            }

            // คำนวณน้ำหนักจาก accuracy (accuracy ต่ำ = weight สูง)
            let totalWeightLat = 0, totalWeightLon = 0, sumWeights = 0;

            positionHistory.forEach(pos => {
                const weight = 1 / (pos.acc + 1); // accuracy ต่ำ = weight สูง
                totalWeightLat += pos.lat * weight;
                totalWeightLon += pos.lon * weight;
                sumWeights += weight;
            });

            return {
                lat: totalWeightLat / sumWeights,
                lon: totalWeightLon / sumWeights
            };
        }

        // ✅ Outlier Detection (ตัดจุดที่เคลื่อนที่เร็วผิดปกติ)
        function isOutlier(currentLat, currentLon, lastLat, lastLon, timeDiff) {
            if (!lastLat || !lastLon || timeDiff === 0) return false;

            const distance = calculateDistance(lastLat, lastLon, currentLat, currentLon);
            const speed = distance / (timeDiff / 1000); // m/s

            // ถ้าความเร็วมากกว่า 200 km/h = ผิดปกติ
            if (speed > MAX_SPEED) {
                console.log(`⚠️ Outlier detected: ${(speed * 3.6).toFixed(1)} km/h`);
                return true;
            }

            return false;
        }

        function updateGPSQuality(accuracy) {
            document.getElementById('gpsAccuracy').textContent = `±${Math.round(accuracy)}m`;
            
            const badge = document.getElementById('gpsQualityBadge');
            
            if (accuracy <= 10) {
                badge.className = 'stat-badge active';
                badge.innerHTML = '<span class="pulse-dot"></span> Excellent';
            } else if (accuracy <= 30) {
                badge.className = 'stat-badge active';
                badge.innerHTML = '<span class="pulse-dot"></span> Good';
            } else if (accuracy <= 50) {
                badge.className = 'stat-badge warning';
                badge.innerHTML = '<span class="pulse-dot"></span> Fair';
            } else {
                badge.className = 'stat-badge error';
                badge.innerHTML = '<span class="pulse-dot"></span> Poor';
            }
        }

        function updateSpeedUI(speed) {
            const kmh = (speed * 3.6).toFixed(1);
            document.getElementById('speedValue').textContent = kmh;
            
            const badge = document.getElementById('speedBadge');
            if (speed < 0.5) {
                badge.className = 'stat-badge inactive';
                badge.innerHTML = '<span class="pulse-dot"></span> ยืนนิ่ง';
            } else if (speed < 2) {
                badge.className = 'stat-badge warning';
                badge.innerHTML = '<span class="pulse-dot"></span> เดิน';
            } else {
                badge.className = 'stat-badge active';
                badge.innerHTML = '<span class="pulse-dot"></span> เคลื่อนที่';
            }
        }

        function showFilterStatus(status, details) {
            const filterStatus = document.getElementById('filterStatus');
            const filterStatusText = document.getElementById('filterStatusText');
            
            filterStatus.style.display = 'flex';
            
            if (status === 'skipped') {
                filterStatus.className = 'filter-status skipped';
                filterStatusText.textContent = `❌ ${details}`;
            } else if (status === 'smoothed') {
                filterStatus.className = 'filter-status smoothed';
                filterStatusText.textContent = `✨ ${details}`;
            }
            
            setTimeout(() => {
                filterStatus.style.display = 'none';
            }, 3000);
        }

        // ✅ ฟังก์ชันหลักในการตรวจสอบและ smooth GPS
        function processGPSPoint(position) {
            totalChecks++;
            
            const rawLat = position.coords.latitude;
            const rawLon = position.coords.longitude;
            const speed = position.coords.speed || 0;
            const accuracy = position.coords.accuracy;
            const timestamp = Date.now();

            // เก็บตำแหน่งปัจจุบันสำหรับ UI
            lastPosition = { lat: rawLat, lon: rawLon, speed, accuracy };
            
            // อัปเดท UI
            updateGPSQuality(accuracy);
            updateSpeedUI(speed);
            document.getElementById('currentLocation').textContent = 
                `${rawLat.toFixed(6)}, ${rawLon.toFixed(6)} (±${Math.round(accuracy)}m)`;
            
            // ❌ Check 1: Accuracy แย่เกินไป
            if (accuracy > MAX_ACCURACY) {
                skippedPoints++;
                console.log(`❌ [${totalChecks}] Poor accuracy: ${accuracy.toFixed(1)}m`);
                showFilterStatus('skipped', `Accuracy แย่: ${accuracy.toFixed(0)}m`);
                return null;
            }
            
            // ❌ Check 2: ความเร็วต่ำเกินไป
            if (speed < MIN_SPEED) {
                skippedPoints++;
                console.log(`⏸️ [${totalChecks}] Speed too low: ${(speed * 3.6).toFixed(1)} km/h`);
                showFilterStatus('skipped', `ยืนนิ่ง: ${(speed * 3.6).toFixed(1)} km/h`);
                return null;
            }

            // ❌ Check 3: Outlier Detection
            if (lastRecordedPosition) {
                const timeDiff = timestamp - (lastRecordedPosition.time || timestamp);
                if (isOutlier(rawLat, rawLon, lastRecordedPosition.lat, lastRecordedPosition.lon, timeDiff)) {
                    skippedPoints++;
                    showFilterStatus('skipped', 'จุดผิดปกติ (เร็วเกินไป)');
                    return null;
                }
            }

            // ✅ Apply Advanced Smoothing
            // 1. EMA Smoothing
            const emaPos = applyEMA(rawLat, rawLon, accuracy);
            
            // 2. Accuracy-Weighted Smoothing
            const weightedPos = accuracyWeightedSmoothing(rawLat, rawLon, accuracy);

            // ผสม EMA และ Weighted Average (ให้น้ำหนัก 50:50)
            const smoothedLat = (emaPos.lat + weightedPos.lat) / 2;
            const smoothedLon = (emaPos.lon + weightedPos.lon) / 2;

            // ❌ Check 4: เคลื่อนที่น้อยเกินไป
            if (lastRecordedPosition) {
                const distance = calculateDistance(
                    lastRecordedPosition.lat, lastRecordedPosition.lon,
                    smoothedLat, smoothedLon
                );
                
                if (distance < MIN_DISTANCE) {
                    skippedPoints++;
                    console.log(`⏸️ [${totalChecks}] Distance too short: ${distance.toFixed(1)}m`);
                    showFilterStatus('skipped', `GPS Drift: ${distance.toFixed(1)}m`);
                    return null;
                }
            }

            // ✅ จุดนี้ผ่านการกรองและ smooth แล้ว
            smoothedPoints++;
            console.log(`✅ [${totalChecks}] Valid & Smoothed: ${(speed * 3.6).toFixed(1)} km/h, ${accuracy.toFixed(1)}m`);
            console.log(`   Raw: ${rawLat.toFixed(6)}, ${rawLon.toFixed(6)}`);
            console.log(`   Smoothed: ${smoothedLat.toFixed(6)}, ${smoothedLon.toFixed(6)}`);
            console.log(`📊 Stats: ${skippedPoints}/${totalChecks} skipped, ${smoothedPoints} smoothed`);
            
            showFilterStatus('smoothed', `จุดที่ ${currentRoute.length + 1} - Smoothed & Saved`);
            
            return {
                latitude: smoothedLat,
                longitude: smoothedLon,
                rawLatitude: rawLat,
                rawLongitude: rawLon,
                accuracy: accuracy,
                speed: speed,
                timestamp: new Date().toISOString()
            };
        }

        async function sendToFirebase(position) {
            const vehicleType = document.getElementById('vehicleType').value;
            const licensePlate = document.getElementById('licensePlate').value;

            try {
                const processed = processGPSPoint(position);
                if (!processed) {
                    // แค่อัปเดท UI แต่ไม่ส่ง Firebase
                    updateMap(position.coords.latitude, position.coords.longitude);
                    return;
                }

                const vehicleKey = licensePlate.replace(/\s+/g, '_');
                const locationData = {
                    vehicleType: vehicleType,
                    licensePlate: licensePlate,
                    latitude: processed.latitude,
                    longitude: processed.longitude,
                    rawLatitude: processed.rawLatitude,
                    rawLongitude: processed.rawLongitude,
                    accuracy: processed.accuracy,
                    speed: processed.speed,
                    timestamp: processed.timestamp,
                    lastUpdated: new Date().toISOString(),
                    smoothingApplied: true
                };

                await database.ref('vehicles/' + vehicleKey).set(locationData);

                const badge = document.getElementById('firebaseBadge');
                badge.className = 'stat-badge active';
                badge.innerHTML = '<span class="pulse-dot"></span> ทำงาน (3s)';
                
                console.log('✅ Firebase updated (3s interval):', new Date().toLocaleTimeString('th-TH'));
            } catch (error) {
                console.error('❌ Error updating Firebase:', error);
            }
        }

        function saveToLocalStorage(position) {
            const vehicleType = document.getElementById('vehicleType').value;
            const licensePlate = document.getElementById('licensePlate').value;

            if (!vehicleType || !licensePlate) {
                showAlert('กรุณากรอกประเภทรถและหมายเลขทะเบียน', 'error');
                stopTracking();
                return;
            }
            
            const processed = processGPSPoint(position);
            if (!processed) {
                updateMap(position.coords.latitude, position.coords.longitude);
                return;
            }

            const locationData = {
                vehicleType: vehicleType,
                licensePlate: licensePlate,
                latitude: processed.latitude,
                longitude: processed.longitude,
                rawLatitude: processed.rawLatitude,
                rawLongitude: processed.rawLongitude,
                accuracy: processed.accuracy,
                speed: processed.speed,
                timestamp: processed.timestamp
            };

            currentRoute.push(locationData);
            lastRecordedPosition = { 
                lat: processed.latitude, 
                lon: processed.longitude,
                time: Date.now()
            };
            
            localStorage.setItem('currentRoute', JSON.stringify(currentRoute));
            localStorage.setItem('vehicleType', vehicleType);
            localStorage.setItem('licensePlate', licensePlate);

            updateMap(processed.latitude, processed.longitude);
            polyline.setLatLngs(currentRoute.map(p => [p.latitude, p.longitude]));
            updatePointCount();

            const now = new Date();
            document.getElementById('lastUpdate').innerHTML = 
                `อัปเดทล่าสุด: <span style="font-weight: 600;">${now.toLocaleTimeString('th-TH')}</span>`;
        }

        function startTracking() {
            const vehicleType = document.getElementById('vehicleType').value;
            const licensePlate = document.getElementById('licensePlate').value;

            if (!vehicleType || !licensePlate) {
                showAlert('กรุณากรอกประเภทรถและหมายเลขทะเบียน', 'error');
                return;
            }

            if (!navigator.geolocation) {
                showAlert('เบราว์เซอร์ไม่รองรับ GPS', 'error');
                return;
            }

            isTracking = true;
            skippedPoints = 0;
            totalChecks = 0;
            smoothedPoints = 0;
            positionHistory = [];
            
            const statusIcon = document.getElementById('statusIcon');
            statusIcon.className = 'status-icon active';
            statusIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
            
            const trackingStatus = document.getElementById('trackingStatus');
            trackingStatus.textContent = 'กำลังติดตาม';
            trackingStatus.className = 'active';

            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('saveBtn').disabled = true;
            document.getElementById('vehicleType').disabled = true;
            document.getElementById('licensePlate').disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    sendToFirebase(position);
                    saveToLocalStorage(position);
                },
                (error) => {
                    console.error('Error getting initial position:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );

            // ✅ เปลี่ยนเป็น 3 วินาที
            firebaseTimer = setInterval(() => {
                navigator.geolocation.getCurrentPosition(
                    sendToFirebase,
                    (error) => {
                        console.error('Error getting position for Firebase:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }, FIREBASE_INTERVAL);

            localStorageTimer = setInterval(() => {
                navigator.geolocation.getCurrentPosition(
                    saveToLocalStorage,
                    (error) => {
                        console.error('Error getting position for local storage:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }, LOCAL_STORAGE_INTERVAL);

            showAlert('🎯 เริ่มติดตามแล้ว - Advanced GPS Smoothing (3s interval)', 'info');
        }

        function stopTracking() {
            if (firebaseTimer) {
                clearInterval(firebaseTimer);
                firebaseTimer = null;
            }

            if (localStorageTimer) {
                clearInterval(localStorageTimer);
                localStorageTimer = null;
            }

            isTracking = false;
            
            const statusIcon = document.getElementById('statusIcon');
            statusIcon.className = 'status-icon inactive';
            statusIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color: #94a3b8;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';
            
            const trackingStatus = document.getElementById('trackingStatus');
            trackingStatus.textContent = 'หยุดชั่วคราว';
            trackingStatus.className = 'inactive';

            const badge = document.getElementById('firebaseBadge');
            badge.className = 'stat-badge inactive';
            badge.innerHTML = '<span class="pulse-dot"></span> ไม่ทำงาน';

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('vehicleType').disabled = false;
            document.getElementById('licensePlate').disabled = false;
            updatePointCount();

            const skipRate = totalChecks > 0 ? ((skippedPoints/totalChecks)*100).toFixed(1) : 0;
            const smoothRate = totalChecks > 0 ? ((smoothedPoints/totalChecks)*100).toFixed(1) : 0;
            showAlert(`✅ หยุดติดตาม | กรอง: ${skippedPoints}/${totalChecks} (${skipRate}%) | Smoothed: ${smoothedPoints} (${smoothRate}%)`, 'success');
        }

        async function saveRouteHistory() {
            if (currentRoute.length === 0) {
                showAlert('ไม่มีข้อมูลให้บันทึก', 'error');
                return;
            }

            const vehicleType = document.getElementById('vehicleType').value;
            const licensePlate = document.getElementById('licensePlate').value;

            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            const originalHTML = saveBtn.innerHTML;
            saveBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="pulse"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                กำลังบันทึก...
            `;

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'saveRouteHistory',
                        vehicleType: vehicleType,
                        licensePlate: licensePlate,
                        route: currentRoute,
                        startTime: currentRoute[0].timestamp,
                        endTime: currentRoute[currentRoute.length - 1].timestamp,
                        totalPoints: currentRoute.length,
                        smoothingApplied: true
                    })
                });

                currentRoute = [];
                lastRecordedPosition = null;
                skippedPoints = 0;
                totalChecks = 0;
                smoothedPoints = 0;
                positionHistory = [];
                emaLat = null;
                emaLon = null;
                localStorage.removeItem('currentRoute');
                polyline.setLatLngs([]);
                updatePointCount();

                showAlert('บันทึกประวัติการเดินทางสำเร็จ! 🎉', 'success');
                saveBtn.innerHTML = originalHTML;
                
            } catch (error) {
                showAlert('เกิดข้อผิดพลาดในการบันทึก', 'error');
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalHTML;
            }
        }

        function showAlert(message, type) {
            const alertSuccess = document.getElementById('alertSuccess');
            const alertError = document.getElementById('alertError');
            const alertInfo = document.getElementById('alertInfo');
            const alertWarning = document.getElementById('alertWarning');
            
            alertSuccess.style.display = 'none';
            alertError.style.display = 'none';
            alertInfo.style.display = 'none';
            alertWarning.style.display = 'none';

            if (type === 'success') {
                document.getElementById('successMessage').textContent = message;
                alertSuccess.style.display = 'flex';
                setTimeout(() => alertSuccess.style.display = 'none', 4000);
            } else if (type === 'error') {
                document.getElementById('errorMessage').textContent = message;
                alertError.style.display = 'flex';
                setTimeout(() => alertError.style.display = 'none', 5000);
            } else if (type === 'info') {
                document.getElementById('infoMessage').textContent = message;
                alertInfo.style.display = 'flex';
                setTimeout(() => alertInfo.style.display = 'none', 4000);
            } else if (type === 'warning') {
                document.getElementById('warningMessage').textContent = message;
                alertWarning.style.display = 'flex';
                setTimeout(() => alertWarning.style.display = 'none', 4000);
            }
        }

        document.getElementById('startBtn').addEventListener('click', startTracking);
        document.getElementById('stopBtn').addEventListener('click', stopTracking);
        document.getElementById('saveBtn').addEventListener('click', saveRouteHistory);

        window.addEventListener('load', () => {
            initMap();
            loadLocalData();
            console.log('🎯 Advanced GPS Filter Ready');
            console.log(`⚙️ Settings:`);
            console.log(`   - Speed: >${(MIN_SPEED*3.6).toFixed(1)} km/h`);
            console.log(`   - Distance: >${MIN_DISTANCE}m`);
            console.log(`   - Accuracy: <${MAX_ACCURACY}m`);
            console.log(`   - Max Speed: <${(MAX_SPEED*3.6).toFixed(0)} km/h`);
            console.log(`   - EMA Alpha: ${EMA_ALPHA}`);
            console.log(`   - History Size: ${POSITION_HISTORY_SIZE}`);
            console.log(`   - Firebase Interval: ${FIREBASE_INTERVAL/1000}s`);
            console.log(`✨ Smoothing: EMA + Accuracy-Weighted Average`);
        });
    </script>
</body>
</html>
